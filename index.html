<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Virtual Jewelry Try-On</title>
    <link rel="stylesheet" href="style.css">
    <!-- <link rel="stylesheet" href="https://cdn.pnj.io/nhan/ring-fitting-simulator/style.css"> -->
</head>

<body>
    <div class="container">
        <div class="header">
            <h2>Virtual Jewelry Try-On</h2>
        </div>

        <div class="camera-container" width="640" height="480">
            <video id="webcam" autoplay playsinline width="640" height="480" style="display:none;"></video>
            <canvas id="canvas" width="640" height="480"></canvas>

            <div class="controls">
                <button id="toggleCam">üì∑</button>
                <button id="refreshBtn">üîÑ</button>
            </div>
        </div>

        <div class="category-selector">
            <button class="active" data-category="rings">üíç Nh·∫´n</button>
            <button data-category="necklaces">üíé V√≤ng c·ªï</button>
            <button data-category="earrings">üß∑ B√¥ng tai</button>
        </div>        

        <div class="product-list">
            <h4>Ch·ªçn Nh·∫´n</h4>
            <div class="product-items">
                <div class="product-item active">
                    <div class="product-preview gold">Au</div>
                    <div class="product-info">
                        <span>Nh·∫´n V√†ng ƒê√≠nh Kim C∆∞∆°ng</span>
                        <strong>12.500.000 VND</strong>
                    </div>
                </div>
                <div class="product-item">
                    <div class="product-preview silver">Ag</div>
                    <div class="product-info">
                        <span>Nh·∫´n B·∫°c ƒê∆°n Gi·∫£n</span>
                        <strong>1.200.000 VND</strong>
                    </div>
                </div>
                <div class="product-item">
                    <div class="product-preview gold-rose"></div>
                    <div class="product-info">
                        <span>Nh·∫´n V√†ng H·ªìng</span>
                        <strong>8.900.000 VND</strong>
                    </div>
                </div>
            </div>
        </div>

        <button class="add-to-cart-btn">Th√™m v√†o gi·ªè h√†ng</button>
    </div>

    <!-- Include TFJS & handpose -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
    <!-- <script src="script.js"></script> -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
                const video = document.getElementById('webcam');
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                const toggleCamBtn = document.getElementById('toggleCam');

                let model, webcamStream, isCamOn = false;

                const ringImg = new Image();
                ringImg.src = "https://cdn.pnj.io/nhan/ring-fitting-simulator/rings/ring1.png";

                const categoryButtons = document.querySelectorAll('.category-selector button');
                const productTitle = document.querySelector('.product-list h4');

                const products = {
                rings: [
                    { name: "Nh·∫´n Kim C∆∞∆°ng", price: "12.500.000 VND", img: "./rings/ring1.png" },
                    { name: "Nh·∫´n B·∫°c ƒê∆°n Gi·∫£n", price: "1.200.000 VND", img: "./rings/ring2.png" },
                    { name: "Nh·∫´n V√†ng H·ªìng", price: "8.900.000 VND", img: "./rings/ring3.png" },
                    { name: "Nh·∫´n V√†ng 18K", price: "15.900.000 VND", img: "./rings/ring4.png" },
                    { name: "Nh·∫´n C∆∞·ªõi Cao C·∫•p", price: "22.000.000 VND", img: "./rings/ring5.png" }
                ],
                necklaces: [
                    { name: "V√≤ng c·ªï B·∫°c", price: "2.500.000 VND", img: "./necklaces/necklace1.png" },
                    { name: "V√≤ng c·ªï Kim C∆∞∆°ng", price: "15.500.000 VND", img: "./necklaces/necklace2.png" },
                    { name: "V√≤ng c·ªï V√†ng", price: "9.500.000 VND", img: "./necklaces/necklace3.png" },
                    { name: "V√≤ng c·ªï Ruby", price: "17.000.000 VND", img: "./necklaces/necklace4.png" },
                    { name: "V√≤ng c·ªï Ng·ªçc trai", price: "7.500.000 VND", img: "./necklaces/necklace5.png" }
                ]
            };

            let currentProducts = products.rings; 

                categoryButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // X√≥a active kh·ªèi t·∫•t c·∫£ button
                        categoryButtons.forEach(btn => btn.classList.remove('active'));

                        // Th√™m active v√†o n√∫t ƒëang ch·ªçn
                        button.classList.add('active');

                        const category = button.getAttribute('data-category');
                        productTitle.textContent = `Ch·ªçn ${button.textContent.trim()}`;

                        // Load s·∫£n ph·∫©m t∆∞∆°ng ·ª©ng (v√≠ d·ª•, ch·ªâ minh h·ªça)
                        loadProducts(category);
                    });
                });

                async function initModel() {
                if (!model) {
                    model = await handpose.load();
                }
            }
            initModel();
                toggleCamBtn.onclick = async () => {
                    if (!isCamOn) {
                        webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        video.srcObject = webcamStream;
                        video.play();
                        toggleCamBtn.textContent = 'T·∫Øt Camera';
                        isCamOn = true;

                        // if (!model) {
                        //     model = await handpose.load();
                        // }
                        renderLoop();
                    } else {
                        webcamStream.getTracks().forEach(track => track.stop());
                        toggleCamBtn.textContent = 'B·∫≠t Camera';
                        isCamOn = false;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                };
                if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                };
                async function renderLoop() {
                    if (isCamOn && model && video.readyState === video.HAVE_ENOUGH_DATA) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        const predictions = await model.estimateHands(video);

                        if (predictions.length > 0) {
                            const finger = predictions[0].annotations.ringFinger;

                            // D√πng ƒë·ªët g·∫ßn (finger[1]) v√† ƒë·ªët gi·ªØa (finger[2]) ƒë·ªÉ fit nh·∫´n ch√≠nh x√°c nh·∫•t
                            const base = finger[1]; // ƒê·ªët g·∫ßn b√†n tay h∆°n
                            const middle = finger[2]; // ƒê·ªët ·ªü gi·ªØa ng√≥n tay

                            if (isMobile()) {
                                drawRotatedRingMobile(base, middle);  // D√†nh ri√™ng cho ƒëi·ªán tho·∫°i
                            } else {
                                drawRotatedRing(base, middle);        // B·∫£n desktop gi·ªØ nguy√™n
                            }
                        }
                    }

                    if (isCamOn) requestAnimationFrame(renderLoop);
                }

                // H√†m fit nh·∫´n ho√†n ch·ªânh nh·∫•t
                // function drawRotatedRing(base, middle) {
                //     const dx = middle[0] - base[0];
                //     const dy = middle[1] - base[1];
                //     const angle = Math.atan2(dy, dx);
                //     const distance = Math.hypot(dx, dy);

                //     // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ƒë·ªÉ fit v·ª´a nh·∫•t
                //     const ringWidth = distance * 1.6; // Chi·ªÅu r·ªông nh·∫´n (c√≥ th·ªÉ tinh ch·ªânh nh·ªè h∆°n ho·∫∑c l·ªõn h∆°n)
                //     const ringHeight = distance * 2.0; // Chi·ªÅu cao nh·∫´n (t√πy ch·ªânh)

                //     // D·ªãch chuy·ªÉn nh·∫π v·ªã tr√≠ hi·ªÉn th·ªã xu·ªëng d∆∞·ªõi m·ªôt ch√∫t
                //     const offsetY = distance * 0.55;

                //     ctx.shadowColor = 'rgba(0,0,0,0.3)';
                //     ctx.shadowBlur = 10;
                //     ctx.shadowOffsetX = 4;
                //     ctx.shadowOffsetY = 4;
                    
                //     ctx.save();
                //     ctx.translate(base[0], base[1]);
                //     ctx.rotate(angle + Math.PI / 2);
                //     ctx.drawImage(
                //         ringImg,
                //         -ringWidth / 2,
                //         -ringHeight / 2 + offsetY,
                //         ringWidth,
                //         ringHeight
                //     );
                //     ctx.restore();
                // }
                function isMobile() {
                return window.innerWidth <= 768;
            }
                function drawRotatedRing(base, middle) {
                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;

                // T√≠nh to√°n scale gi·ªØa video v√† canvas
                const scaleX = canvasWidth / videoWidth;
                const scaleY = canvasHeight / videoHeight;

                // √Åp d·ª•ng scale v√†o t·ªça ƒë·ªô base v√† tip
                const scaledBase = [base[0] * scaleX, base[1] * scaleY];
                const scaledTip = [middle[0] * scaleX, middle[1] * scaleY];

                const dx = scaledTip[0] - scaledBase[0];
                const dy = scaledTip[1] - scaledBase[1];
                const angle = Math.atan2(dy, dx);
                const distance = Math.hypot(dx, dy);

                // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc nh·∫´n theo scale
                const ringWidth = distance * 1.6;
                const ringHeight = distance * 2.0;

                const offsetY = distance * 0.75;

                const centerX = (scaledBase[0] + scaledTip[0]) / 2;
                const centerY = (scaledBase[1] + scaledTip[1]) / 2;

                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle + Math.PI / 2);

                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 3;
                ctx.shadowOffsetY = 3;

                ctx.drawImage(
                    ringImg,
                    -ringWidth / 2,
                    -ringHeight / 2 + offsetY,
                    ringWidth,
                    ringHeight
                );
                ctx.restore();
            }

            function drawRotatedRingMobile(base, middle) {
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;

                    // T√≠nh to√°n scale d·ª±a tr√™n k√≠ch th∆∞·ªõc video v√† canvas
                    const scaleX = canvasWidth / videoWidth;
                    const scaleY = canvasHeight / videoHeight;

                    // Scale l·∫°i c√°c ƒëi·ªÉm base, tip ph√π h·ª£p v·ªõi canvas
                    const scaledBase = [base[0] * scaleX, base[1] * scaleY];
                    const scaledTip = [middle[0] * scaleX, middle[1] * scaleY];

                    const dx = scaledTip[0] - scaledBase[0];
                    const dy = scaledTip[1] - scaledBase[1];
                    const angle = Math.atan2(dy, dx);
                    const distance = Math.hypot(dx, dy);

                    // ƒê√£ test t·ªëi ∆∞u cho m√†n h√¨nh ƒëi·ªán tho·∫°i
                    const ringWidth = distance * 1.6; // nh·ªè h∆°n ch√∫t cho mobile
                    const ringHeight = distance * 2.0;

                    const offsetY = distance * 0.55;

                    const centerX = (scaledBase[0] + scaledTip[0]) / 2;
                    const centerY = (scaledBase[1] + scaledTip[1]) / 2;

                    ctx.save();
                    ctx.translate(centerX, centerY);
                    ctx.rotate(angle + Math.PI / 2);

                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;

                    ctx.drawImage(
                        ringImg,
                        -ringWidth / 2,
                        -ringHeight / 2 + offsetY,
                        ringWidth,
                        ringHeight
                    );
                    ctx.restore();
                }
            });

            function loadProducts(category) {
                const productItems = document.querySelector('.product-items');
                productItems.innerHTML = '';

                const items = {
                    rings: [
                        { name: 'Nh·∫´n V√†ng ƒê√≠nh Kim C∆∞∆°ng', price: '12.500.000 VND' },
                        { name: 'Nh·∫´n B·∫°c ƒê∆°n Gi·∫£n', price: '1.200.000 VND' },
                        { name: 'Nh·∫´n V√†ng H·ªìng', price: '8.900.000 VND' }
                    ],
                    necklaces: [
                        { name: 'V√≤ng C·ªï Kim C∆∞∆°ng', price: '15.500.000 VND' },
                        { name: 'V√≤ng C·ªï B·∫°c', price: '2.500.000 VND' },
                        { name: 'V√≤ng C·ªï V√†ng', price: '9.500.000 VND' }
                    ],
                    earrings: [
                        { name: 'B√¥ng tai Kim C∆∞∆°ng', price: '5.500.000 VND' },
                        { name: 'B√¥ng tai B·∫°c', price: '700.000 VND' },
                        { name: 'B√¥ng tai V√†ng', price: '3.500.000 VND' }
                    ]
                };

                items[category].forEach(item => {
                    productItems.innerHTML += `
          <div class="product-item">
              <div class="product-preview"></div>
              <div class="product-info">
                  <span>${item.name}</span>
                  <strong>${item.price}</strong>
              </div>
          </div>`;
                });
            }
    </script>
</body>

</html>
